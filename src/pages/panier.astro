---
import Layout from "../layouts/Layout.astro";
---

<Layout>
	<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
		<div class="max-w-6xl mx-auto">
			
			<!-- Header de la page -->
			<div class="mb-8">
				<h1 class="text-3xl font-bold text-gray-900">Mon Panier</h1>
				<p class="text-gray-600 mt-2">Vos créations prêtes à être commandées</p>
			</div>

			<!-- Grid 2 colonnes -->
			<div class="grid lg:grid-cols-3 gap-6">
				
				<!-- Colonne gauche : Articles du panier -->
				<div class="lg:col-span-2 space-y-4">
					
					<!-- Liste des articles -->
					<div id="cart-items" class="space-y-4">
						<!-- Les articles seront ajoutés ici dynamiquement -->
					</div>

					<!-- Message panier vide -->
					<div id="empty-cart" class="bg-white rounded-xl shadow-sm border border-gray-200 p-12">
						<div class="text-center text-gray-500">
							<svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
							</svg>
							<p class="text-lg font-medium mb-2">Votre panier est vide</p>
							<p class="text-sm text-gray-400 mb-6">Commencez par créer vos lunettes personnalisées</p>
							<a href="/configurateur" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
								</svg>
								Créer des lunettes
							</a>
						</div>
					</div>

				</div>

				<!-- Colonne droite : Résumé de la commande -->
				<div class="lg:col-span-1">
					
					<!-- Card Résumé -->
					<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-20">
						<h2 class="text-lg font-semibold text-gray-900 mb-6">Résumé de la commande</h2>
						
						<div class="space-y-3 mb-6">
							<div class="flex justify-between text-sm">
								<span class="text-gray-600">Sous-total (<span id="item-count">0</span> articles)</span>
								<span class="font-medium text-gray-900"><span id="subtotal">0.00</span> €</span>
							</div>
							<div class="flex justify-between text-sm">
								<span class="text-gray-600">Livraison</span>
								<span class="font-medium text-gray-900"><span id="shipping">0.00</span> €</span>
							</div>
							<div class="border-t border-gray-200 pt-3 mt-3">
								<div class="flex justify-between">
									<span class="text-base font-semibold text-gray-900">Total</span>
									<span class="text-xl font-bold text-blue-600"><span id="total">0.00</span> €</span>
								</div>
							</div>
						</div>

						<button
							id="checkout-btn"
							disabled
							class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 mb-3"
						>
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
							</svg>
							Passer la commande
						</button>

						<a href="/configurateur" class="block text-center text-sm text-blue-600 hover:text-blue-700 font-medium">
							Continuer mes créations
						</a>

						<!-- Info livraison -->
						<div class="mt-6 pt-6 border-t border-gray-200">
							<div class="flex items-start gap-3 text-xs text-gray-600">
								<svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
								</svg>
								<p>Livraison gratuite à partir de 100€</p>
							</div>
							<div class="flex items-start gap-3 text-xs text-gray-600 mt-2">
								<svg class="w-5 h-5 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
								</svg>
								<p>Expédition sous 2-3 jours ouvrés</p>
							</div>
						</div>
					</div>

				</div>

			</div>

		</div>
	</div>
</Layout>

<script type="module">
	const { pb } = await import('/src/lib/pb.js');

	// Rediriger si non connecté
	if (!pb.authStore.isValid) {
		location.href = '/login';
	}

	const user = pb.authStore.model;
	const userId = user?.id;

	// Prix de base pour une paire de lunettes
	const SHIPPING_THRESHOLD = 100;
	const SHIPPING_COST = 4.99;

	// Charger le panier depuis localStorage avec clé spécifique à l'utilisateur
	const cartKey = `cart_${userId}`;
	let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');

	const cartItemsContainer = document.getElementById('cart-items');
	const emptyCart = document.getElementById('empty-cart');
	const itemCount = document.getElementById('item-count');
	const subtotalEl = document.getElementById('subtotal');
	const shippingEl = document.getElementById('shipping');
	const totalEl = document.getElementById('total');
	const checkoutBtn = document.getElementById('checkout-btn');

	function renderCart() {
		if (cart.length === 0) {
			cartItemsContainer.innerHTML = '';
			emptyCart.classList.remove('hidden');
			checkoutBtn.disabled = true;
			updateSummary();
			return;
		}

		emptyCart.classList.add('hidden');
		checkoutBtn.disabled = false;

		cartItemsContainer.innerHTML = cart.map((item, index) => `
			<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
				<div class="flex gap-4">
					<!-- Image/Preview -->
					<div class="w-24 h-24 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg flex items-center justify-center shrink-0 p-2 border border-gray-200">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="70 110 460 180" class="w-full h-full">
							<style>
								.preview-branches-${index} { fill: ${item.branchesColor || '#D3D3D3'}; stroke: #1d1d1b; stroke-miterlimit: 10; stroke-width: .5px; }
								.preview-monture-${index} { fill: ${item.montureColor || '#8B8B8B'}; stroke: #1d1d1b; stroke-miterlimit: 10; stroke-width: .5px; }
								.preview-verres-${index} { fill: ${item.verresColor || '#E0F2FF'}; opacity: .75; }
							</style>
							<g>
								<g class="preview-branches-${index}">
									<path d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
									<path d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
								</g>
								<g class="preview-monture-${index}">
									<path d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z"/>
								</g>
								<g class="preview-verres-${index}">
									<path d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
									<path d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
								</g>
							</g>
						</svg>
					</div>

					<!-- Détails -->
					<div class="flex-1">
						<div class="flex justify-between items-start mb-2">
							<div>
								<h3 class="font-semibold text-gray-900">${item.name || 'Lunettes personnalisées'}</h3>
								<p class="text-sm text-gray-500 mt-1">Taille: ${item.size || 'M'}</p>
							</div>
							<button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Supprimer">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
								</svg>
							</button>
						</div>

						<!-- Couleurs -->
						<div class="flex flex-wrap gap-2 mb-3">
							<div class="flex items-center gap-1.5 text-xs">
								<span class="text-gray-500">Monture:</span>
								<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${item.montureColor || '#000'}"></div>
							</div>
							<div class="flex items-center gap-1.5 text-xs">
								<span class="text-gray-500">Branches:</span>
								<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${item.branchesColor || '#000'}"></div>
							</div>
							<div class="flex items-center gap-1.5 text-xs">
								<span class="text-gray-500">Verres:</span>
								<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${item.verresColor || '#000'}"></div>
							</div>
						</div>

						<!-- Prix et quantité -->
						<div class="flex justify-between items-center">
							<div class="flex items-center gap-3">
								<button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
									</svg>
								</button>
								<span class="font-medium text-gray-900 w-8 text-center">${item.quantity || 1}</span>
								<button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
									</svg>
								</button>
							</div>
							<div class="text-right">
								<p class="text-lg font-bold text-gray-900">${((item.totalPrice || 89.99) * (item.quantity || 1)).toFixed(2)} €</p>
								<p class="text-xs text-gray-500">${(item.totalPrice || 89.99).toFixed(2)} € / unité</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		`).join('');

		updateSummary();
	}

	function updateSummary() {
		const subtotal = cart.reduce((sum, item) => sum + ((item.totalPrice || 89.99) * (item.quantity || 1)), 0);
		const shipping = subtotal >= SHIPPING_THRESHOLD ? 0 : (cart.length > 0 ? SHIPPING_COST : 0);
		const total = subtotal + shipping;

		itemCount.textContent = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
		subtotalEl.textContent = subtotal.toFixed(2);
		shippingEl.textContent = shipping.toFixed(2);
		totalEl.textContent = total.toFixed(2);
	}

	// Fonction globale pour supprimer un article
	window.removeFromCart = function(index) {
		if (confirm('Supprimer cet article du panier ?')) {
			cart.splice(index, 1);
			localStorage.setItem(cartKey, JSON.stringify(cart));
			renderCart();
		}
	};

	// Fonction globale pour mettre à jour la quantité
	window.updateQuantity = function(index, delta) {
		const item = cart[index];
		const newQuantity = (item.quantity || 1) + delta;
		
		if (newQuantity < 1) {
			removeFromCart(index);
			return;
		}
		
		item.quantity = newQuantity;
		localStorage.setItem(cartKey, JSON.stringify(cart));
		renderCart();
	};

	// Bouton commander
	checkoutBtn.addEventListener('click', () => {
		alert('Fonctionnalité de paiement à venir ! Total: ' + totalEl.textContent + ' €');
		// TODO: Implémenter le processus de paiement
	});

	// Initialiser l'affichage
	renderCart();
</script>
