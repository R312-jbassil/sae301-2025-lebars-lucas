---
import Layout from "../layouts/Layout.astro";
---

<Layout>
	<section class="min-h-screen bg-gray-50 py-12">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			
			<!-- Header -->
			<div class="mb-8">
				<h1 class="text-4xl font-bold text-gray-900 mb-2">Mes Créations</h1>
				<p class="text-lg text-gray-600">Retrouvez toutes vos lunettes personnalisées sauvegardées</p>
			</div>

			<!-- Empty state -->
			<div id="empty-state" class="hidden bg-white rounded-2xl border border-gray-200 p-12 text-center">
				<svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
				</svg>
				<p class="text-lg font-medium text-gray-900 mb-2">Aucune création sauvegardée</p>
				<p class="text-sm text-gray-500 mb-6">Commencez par créer et sauvegarder vos lunettes personnalisées</p>
				<a href="/configurateur" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
					</svg>
					Créer mes lunettes
				</a>
			</div>

			<!-- Grid de créations -->
			<div id="creations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
				<!-- Les cartes seront ajoutées ici dynamiquement -->
			</div>

		</div>
	</section>
</Layout>

<script type="module">
	import { pb } from '/src/lib/pb.js';

	// Check authentication
	if (!pb.authStore.isValid) {
		window.location.href = '/login';
	}

	const creationsGrid = document.getElementById('creations-grid');
	const emptyState = document.getElementById('empty-state');

	// Load saved creations
	async function loadCreations() {
		try {
			// Filter by current user
			const userId = pb.authStore.model?.id;
			const records = await pb.collection('lunette_sauvegardee').getFullList({
				sort: '-created',
				filter: `id_utilisateur = "${userId}"`,
				expand: 'id_monture,id_branche,id_verre,id_pont,id_taille_verre'
			});

			if (records.length === 0) {
				emptyState?.classList.remove('hidden');
				return;
			}

			creationsGrid.innerHTML = records.map(record => {
				// Get expanded relations
				const monture = record.expand?.id_monture;
				const branche = record.expand?.id_branche;
				const verre = record.expand?.id_verre;
				const pont = record.expand?.id_pont;
				const verresTaille = record.expand?.id_taille_verre;
				
				// Parse additional configuration
				let configData = { size: 'M', totalPrice: 89.99 };
				try {
					configData = JSON.parse(record.prompt_ia || '{}');
				} catch (e) {
					console.error('Error parsing config:', e);
				}
				
				// Build config object from relations
				const config = {
					size: configData.size || 'M',
					montureColor: monture?.code_hex_apercu || '#8B8B8B',
					montureMaterial: monture?.libelle || 'Aluminum',
					branchesColor: branche?.code_hex_apercu || '#D3D3D3',
					branchesMaterial: branche?.libelle || 'Gunmetal',
					verresColor: verre?.code_hex_apercu || '#E0F2FF',
					verresType: verre?.libelle || 'Classique'
				};
				
				const totalPrice = configData.totalPrice || 89.99;

				return `
					<div class="bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-lg transition-shadow overflow-hidden">
						<!-- Preview -->
						<div class="bg-gradient-to-br from-gray-50 to-gray-100 p-8 flex items-center justify-center min-h-[250px]">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="70 110 460 180" class="w-full h-auto max-w-xs">
								<style>
									.creation-branches-${record.id} { fill: ${config.branchesColor || '#D3D3D3'}; stroke: #1d1d1b; stroke-miterlimit: 10; stroke-width: .5px; }
									.creation-monture-${record.id} { fill: ${config.montureColor || '#8B8B8B'}; stroke: #1d1d1b; stroke-miterlimit: 10; stroke-width: .5px; }
									.creation-verres-${record.id} { fill: ${config.verresColor || '#E0F2FF'}; opacity: .75; }
								</style>
								<g>
									<g class="creation-branches-${record.id}">
										<path d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
										<path d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
									</g>
									<g class="creation-monture-${record.id}">
										<path d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z"/>
									</g>
									<g class="creation-verres-${record.id}">
										<path d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
										<path d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
									</g>
								</g>
							</svg>
						</div>

						<!-- Info -->
						<div class="p-6">
							<h3 class="text-lg font-semibold text-gray-900 mb-2">${record.nom_configuration || 'Lunettes personnalisées'}</h3>
							
							<!-- Details -->
							<div class="space-y-2 mb-4 text-sm text-gray-600">
								<div class="flex items-center gap-2">
									<span class="font-medium">Taille:</span>
									<span>${config.size || 'M'}</span>
								</div>
								<div class="flex items-center gap-2">
									<span class="font-medium">Monture:</span>
									<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${config.montureColor || '#8B8B8B'}"></div>
									<span>${config.montureMaterial || 'Aluminum'}</span>
								</div>
								<div class="flex items-center gap-2">
									<span class="font-medium">Branches:</span>
									<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${config.branchesColor || '#D3D3D3'}"></div>
									<span>${config.branchesMaterial || 'Gunmetal'}</span>
								</div>
								<div class="flex items-center gap-2">
									<span class="font-medium">Verres:</span>
									<div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${config.verresColor || '#E0F2FF'}"></div>
									<span>${config.verresType || 'Classique'}</span>
								</div>
							</div>

							<!-- Price & Date -->
							<div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
								<span class="text-lg font-bold text-blue-600">${totalPrice.toFixed(2)} €</span>
								<span class="text-xs text-gray-500">${new Date(record.created).toLocaleDateString('fr-FR')}</span>
							</div>

							<!-- Actions -->
							<div class="flex gap-2">
								<button onclick="addToCart('${record.id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">
									Ajouter au panier
								</button>
								<button onclick="deleteCreation('${record.id}')" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg font-medium hover:bg-red-50 transition-colors text-sm">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
									</svg>
								</button>
							</div>
						</div>
					</div>
				`;
			}).join('');

		} catch (error) {
			console.error('Error loading creations:', error);
			alert('Erreur lors du chargement des créations');
		}
	}

	// Add to cart
	window.addToCart = async function(recordId) {
		try {
			const record = await pb.collection('lunette_sauvegardee').getOne(recordId, {
				expand: 'id_monture,id_branche,id_verre,id_pont,id_taille_verre'
			});
			
			// Get expanded relations
			const monture = record.expand?.id_monture;
			const branche = record.expand?.id_branche;
			const verre = record.expand?.id_verre;
			const pont = record.expand?.id_pont;
			const verresTaille = record.expand?.id_taille_verre;
			
			// Parse additional config
			let configData = { size: 'M', sizePrice: 0, monturePrice: 0, branchesPrice: 0, verresPrice: 0, totalPrice: 89.99 };
			try {
				configData = JSON.parse(record.prompt_ia || '{}');
			} catch (e) {
				console.error('Error parsing config:', e);
			}

			// Get user-specific cart key
			const userId = pb.authStore.model?.id;
			const cartKey = `cart_${userId}`;
			const cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
			
			const cartItem = {
				name: record.nom_configuration || "Lunettes personnalisées",
				size: configData.size || 'M',
				sizeValue: configData.sizeValue || '350mm',
				montureColor: monture?.code_hex_apercu || '#8B8B8B',
				montureName: monture?.libelle || 'Aluminum',
				montureMaterial: monture?.libelle || 'Aluminum',
				branchesColor: branche?.code_hex_apercu || '#D3D3D3',
				branchesName: branche?.libelle || 'Gunmetal',
				branchesMaterial: branche?.libelle || 'Gunmetal',
				verresColor: verre?.code_hex_apercu || '#E0F2FF',
				verresName: verre?.libelle || 'Classique',
				verresType: verre?.libelle || 'Classique',
				pont: pont?.libelle || '17mm',
				verresTaille: verresTaille?.libelle || '50mm',
				basePrice: 89.99,
				sizePrice: configData.sizePrice || 0,
				monturePrice: configData.monturePrice || 0,
				branchesPrice: configData.branchesPrice || 0,
				verresPrice: configData.verresPrice || 0,
				totalPrice: configData.totalPrice || 89.99,
				quantity: 1
			};

			cart.push(cartItem);
			localStorage.setItem(cartKey, JSON.stringify(cart));
			window.dispatchEvent(new Event('cartUpdated'));
			
			alert('✅ Lunettes ajoutées au panier !');
		} catch (error) {
			console.error('Error adding to cart:', error);
			alert('❌ Erreur lors de l\'ajout au panier');
		}
	};

	// Delete creation
	window.deleteCreation = async function(recordId) {
		if (!confirm('Êtes-vous sûr de vouloir supprimer cette création ?')) {
			return;
		}

		try {
			await pb.collection('lunette_sauvegardee').delete(recordId);
			alert('✅ Création supprimée');
			loadCreations(); // Reload
		} catch (error) {
			console.error('Error deleting creation:', error);
			alert('❌ Erreur lors de la suppression');
		}
	};

	// Load on page load
	loadCreations();
</script>
</Layout>
